<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Danfoss KBA Search & Viewer</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; background-color: #f8f9fa; }
header { background-color: #002b5c; color: white; padding: 1em; display: flex; justify-content: space-between; align-items: center; }
.note-list a { display: block; padding: 10px; border-bottom: 1px solid #eee; text-decoration: none; color: #002b5c; cursor: pointer; }
.note-list a:hover { background: #f0f0f0; }
.note-container { display: flex; flex-wrap: wrap; gap: 1em; height: 80vh; }
.note-left { flex: 2; min-width: 300px; background: white; padding: 1em; border-radius: 5px; overflow-y: auto; }
.note-right { flex: 1; min-width: 250px; background: white; padding: 1em; border-radius: 5px; overflow: auto; position: relative; }
.note-right img { max-width: none; max-height: none; cursor: grab; }
.full-width { flex: 1 1 100%; }
h1, h2 { color: #002b5c; }
ul { padding-left: 20px; }
.zoom-controls { position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.8); padding: 5px; border-radius: 5px; display: flex; gap: 5px; }
.zoom-controls button { padding: 5px; cursor: pointer; }
.hidden { display: none; }
</style>
</head>
<body>
<header>
  <div class="logo">Danfoss KBA</div>
</header>

<main>
  <!-- List View -->
  <div id="listView">
    <div id="results" class="note-list">Loading KBAs...</div>
  </div>

  <!-- Note View -->
  <div id="noteView" class="hidden">
    <div id="noteContent"></div>
  </div>
</main>

<footer>
  <p>&copy; 2025 Danfoss. All rights reserved.</p>
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const INDEX_URL = `${window.location.origin}/KBA_NOTES/index.json`;
  let notesList = [];

  async function loadIndex() {
    try {
      const res = await fetch(INDEX_URL);
      const ids = await res.json();
      notesList = [];

      for (let entry of ids) {
        const fileUrl = `${window.location.origin}/KBA_NOTES/${entry.id}.json`;
        try {
          const noteRes = await fetch(fileUrl);
          if (!noteRes.ok) throw new Error(`HTTP error! status: ${noteRes.status}`);
          const noteData = await noteRes.json();
          notesList.push({
            id: entry.id,
            title: noteData.Title || "Untitled KBA"
          });
        } catch {
          notesList.push({ id: entry.id, title: "Untitled KBA" });
        }
      }
      renderList(notesList);
    } catch {
      document.getElementById("results").innerHTML = "<p>Error loading index.json</p>";
    }
  }

  function renderList(list) {
    document.getElementById("results").innerHTML = list.map(note => 
      `<a href="#" data-id="${note.id}">${note.title}</a>`
    ).join("");
  }

  document.getElementById("results").addEventListener("click", e => {
    if (e.target.tagName === "A") {
      e.preventDefault();
      loadNote(e.target.getAttribute("data-id"));
    }
  });

  async function loadNote(noteId) {
    const fileUrl = `${window.location.origin}/KBA_NOTES/${noteId}.json`;
    try {
      const response = await fetch(fileUrl);
      if (!response.ok) throw new Error();
      const note = await response.json();
      renderNote(note);
    } catch {
      document.getElementById('noteContent').innerHTML = `<p>Note not found: ${noteId}</p>`;
    }
  }

  function renderNote(note) {
    const hasImage = note.Images && note.Images.length > 0;
    document.getElementById('listView').classList.add('hidden');
    document.getElementById('noteView').classList.remove('hidden');

    document.getElementById('noteContent').innerHTML = `
      <div class="note-container">
        <div class="note-left ${!hasImage ? 'full-width' : ''}">
          <h1>${note.KBA || ''}: ${note.Title || ''}</h1>
          <p><strong>Date:</strong> ${note.Date || ''}</p>
          <p><strong>Environment:</strong> ${note.Environment || ''}</p>
          <p><strong>Action Definition:</strong> ${note["Action Definition"] || ''}</p>
          <h2>Description</h2><p>${note.Description || ''}</p>
          <h2>Symptom</h2><p>${note.Symptom || ''}</p>
          <h2>Reproducing the Issue</h2>
          <ul>${(note["Reproducing the Issue"] || []).map(step => `<li>${step}</li>`).join('')}</ul>
          <h2>Cause</h2><p>${note.Cause || ''}</p>
          <h2>Resolution</h2><p>${note.Resolution || ''}</p>
          <h2>Additional Info</h2>
          <ul>
            ${note["Additional Info"] ? Object.entries(note["Additional Info"]).map(([k,v]) => `<li><strong>${k}:</strong> ${v}</li>`).join('') : ''}
          </ul>
          <button id="backBtn">Back to Search</button>
        </div>
        ${hasImage ? `
        <div class="note-right" id="imageContainer">
          <img id="zoomImg" src="${note.Images[0]}" alt="KBA Image">
          <div class="zoom-controls">
            <button id="zoomIn">+</button>
            <button id="zoomOut">-</button>
            <button id="resetZoom">Reset</button>
          </div>
        </div>` : ''}
      </div>
    `;

    document.getElementById("backBtn").addEventListener("click", () => {
      document.getElementById('noteView').classList.add('hidden');
      document.getElementById('listView').classList.remove('hidden');
    });

    if (hasImage) {
      let scale = 1;
      let isDragging = false;
      let startX, startY;
      const zoomImg = document.getElementById("zoomImg");
      const imageContainer = document.getElementById("imageContainer");

      document.getElementById("zoomIn").addEventListener("click", () => {
        scale += 0.2;
        zoomImg.style.transform = `scale(${scale})`;
      });

      document.getElementById("zoomOut").addEventListener("click", () => {
        scale = Math.max(1, scale - 0.2);
        zoomImg.style.transform = `scale(${scale})`;
      });

      document.getElementById("resetZoom").addEventListener("click", () => {
        scale = 1;
        zoomImg.style.transform = `scale(${scale}) translate(0,0)`;
        imageContainer.scrollTop = 0;
        imageContainer.scrollLeft = 0;
      });

      zoomImg.addEventListener("mousedown", e => {
        isDragging = true;
        startX = e.pageX - imageContainer.offsetLeft;
        startY = e.pageY - imageContainer.offsetTop;
        zoomImg.style.cursor = "grabbing";
      });

      zoomImg.addEventListener("mouseup", () => {
        isDragging = false;
        zoomImg.style.cursor = "grab";
      });

      zoomImg.addEventListener("mouseleave", () => {
        isDragging = false;
        zoomImg.style.cursor = "grab";
      });

      zoomImg.addEventListener("mousemove", e => {
        if (!isDragging) return;
        e.preventDefault();
        imageContainer.scrollLeft -= (e.movementX);
        imageContainer.scrollTop -= (e.movementY);
      });
    }
  }

  loadIndex();
});
</script>
</body>
</html>
