<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Danfoss KBA Search & Viewer</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  margin: 0;
  background: linear-gradient(to bottom right, #f0f4f8, #e6ebf0);
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}
header {
  background-color: #002b5c;
  color: white;
  padding: 1em;
  font-size: 1.2em;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
main { flex: 1; padding: 1em; display: flex; gap: 1em; }
.left-pane { flex: 3; }
.right-pane { flex: 1; background: white; padding: 1em; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
.search-bar {
  margin-bottom: 1em;
  display: flex;
  gap: 10px;
}
.search-bar input {
  padding: 8px;
  flex: 1;
  border-radius: 5px;
  border: 1px solid #ccc;
}
.tiles {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.tile {
  background: #f9fbfd;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  cursor: pointer;
  min-width: 120px;
  text-align: center;
}
.tile:hover { background: #e6ebf0; }
.note-list a {
  display: block;
  padding: 10px;
  margin-bottom: 5px;
  background: white;
  border-radius: 6px;
  text-decoration: none;
  color: #002b5c;
  font-weight: 500;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.note-list a:hover { background: #f9fbfd; }
.note-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1em;
}
.note-left {
  flex: 2;
  min-width: 300px;
  background: white;
  padding: 1.5em;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  overflow-y: auto;
}
.note-right {
  flex: 1.5;
  min-width: 350px;
  background: white;
  padding: 1em;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  overflow: auto;
  position: relative;
}
.note-right img {
  margin-top: 10cm; /* move image down */
  max-width: none;
  max-height: none;
  cursor: grab;
  border-radius: 5px;
}
.full-width { flex: 1 1 100%; }
h1, h2 { color: #002b5c; }
ul { padding-left: 20px; }
.zoom-controls {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(255,255,255,0.9);
  padding: 5px;
  border-radius: 5px;
  display: flex;
  gap: 5px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.zoom-controls button {
  padding: 5px 8px;
  cursor: pointer;
  border: none;
  background: #002b5c;
  color: white;
  border-radius: 4px;
}
.zoom-controls button:hover { background: #004080; }
footer {
  background-color: #002b5c;
  color: white;
  text-align: center;
  padding: 0.8em;
  font-size: 0.9em;
  margin-top: auto;
}
.hidden { display: none; }
#backBtn {
  background: #002b5c;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 5px;
  cursor: pointer;
  margin-bottom: 1em;
}
#backBtn:hover { background: #004080; }
</style>
</head>
<body>
<header>
  <div class="logo">Danfoss KBA</div>
</header>

<main>
  <!-- Left pane: List View -->
  <div class="left-pane" id="listView">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search KBAs...">
    </div>
    <div id="results" class="note-list">Loading KBAs...</div>
  </div>

  <!-- Right pane: Frequently searched -->
  <div class="right-pane">
    <h3>Frequently Searched Notes</h3>
    <div id="tiles" class="tiles"></div>
  </div>

  <!-- Note View -->
  <div id="noteView" class="hidden" style="width: 100%;">
    <div id="noteContent"></div>
  </div>
</main>

<footer>
  <p>© 2025 Danfoss. All rights reserved.</p>
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const INDEX_URL = `${window.location.origin}/KBA_NOTES/JSON/index.json`;
  let notesList = [];
  let searchHistory = JSON.parse(localStorage.getItem("searchHistory") || "[]");

  async function loadIndex() {
    try {
      const res = await fetch(INDEX_URL);
      const ids = await res.json();
      notesList = [];
      for (let entry of ids) {
        const fileUrl = `${window.location.origin}/KBA_NOTES/JSON/${entry.id}.json`;
        try {
          const noteRes = await fetch(fileUrl);
          if (!noteRes.ok) throw new Error();
          const noteData = await noteRes.json();
          notesList.push({ id: entry.id, title: noteData.Title || "Untitled KBA" });
        } catch {
          notesList.push({ id: entry.id, title: "Untitled KBA" });
        }
      }
      renderList(notesList);
      renderTiles();
    } catch {
      document.getElementById("results").innerHTML = "<p>Error loading index.json</p>";
    }
  }

  function renderList(list) {
    document.getElementById("results").innerHTML = list.map(note =>
      `<a href="#" data-id="${note.id}">${note.title}</a>`
    ).join("");
  }

  function renderTiles() {
    const tilesContainer = document.getElementById("tiles");
    const sorted = [...searchHistory].sort((a,b) => b.count - a.count).slice(0,5);
    tilesContainer.innerHTML = sorted.map(item =>
      `<div class="tile" data-id="${item.id}">${item.title}</div>`
    ).join("");
  }

  document.getElementById("searchInput").addEventListener("input", e => {
    const query = e.target.value.toLowerCase();
    const filtered = notesList.filter(note =>
      note.title.toLowerCase().includes(query) || note.id.includes(query)
    );
    renderList(filtered);
  });

  document.getElementById("results").addEventListener("click", e => {
    if (e.target.tagName === "A") {
      e.preventDefault();
      loadNote(e.target.getAttribute("data-id"));
    }
  });

  document.getElementById("tiles").addEventListener("click", e => {
    if (e.target.classList.contains("tile")) {
      loadNote(e.target.getAttribute("data-id"));
    }
  });

  async function loadNote(noteId) {
    const fileUrl = `${window.location.origin}/KBA_NOTES/JSON/${noteId}.json`;
    try {
      const response = await fetch(fileUrl);
      if (!response.ok) throw new Error();
      const note = await response.json();
      addToSearchHistory(noteId, note.Title);
      renderNote(note);
    } catch {
      document.getElementById('noteContent').innerHTML = `<p>Note not found: ${noteId}</p>`;
    }
  }

  function addToSearchHistory(id, title) {
    const existing = searchHistory.find(item => item.id === id);
    if (existing) {
      existing.count++;
    } else {
      searchHistory.push({ id, title, count: 1 });
    }
    localStorage.setItem("searchHistory", JSON.stringify(searchHistory));
    renderTiles();
  }

  function renderNote(note) {
    const hasImage = note.Images && note.Images.length > 0;
    document.getElementById('listView').classList.add('hidden');
    document.querySelector('.right-pane').classList.add('hidden');
    document.getElementById('noteView').classList.remove('hidden');

    document.getElementById('noteContent').innerHTML = `
      <div class="note-container">
        <div class="note-left ${!hasImage ? 'full-width' : ''}">
          <button id="backBtn">← Back to Search</button>
          <h1>${note.KBA || ''}: ${note.Title || ''}</h1>
          <p><strong>Date:</strong> ${note.Date || ''}</p>
          <p><strong>Environment:</strong> ${note.Environment || ''}</p>
          <p><strong>Action Definition:</strong> ${note["Action Definition"] || ''}</p>
          <h2>Description</h2><p>${note.Description || ''}</p>
          <h2>Symptom</h2><p>${note.Symptom || ''}</p>
          <h2>Reproducing the Issue</h2>
          <ul>${(note["Reproducing the Issue"] || []).map(step => `<li>${step}</li>`).join('')}</ul>
          <h2>Cause</h2><p>${note.Cause || ''}</p>
          <h2>Resolution</h2><p>${note.Resolution || ''}</p>
          <h2>Additional Info</h2>
          <ul>
            ${note["Additional Info"] ? Object.entries(note["Additional Info"]).map(([k,v]) => `<li><strong>${k}:</strong> ${v}</li>`).join('') : ''}
          </ul>
        </div>
        ${hasImage ? `
        <div class="note-right" id="imageContainer">
          <div class="zoom-controls">
            <button id="zoomIn">+</button>
            <button id="zoomOut">-</button>
            <button id="resetZoom">Reset</button>
            <a id="downloadImg" href="${window.location.origin}/KBA_NOTES/Images/KLT_BMW.jpg" download>
              <button>Download</button>
            </a>
          </div>
          <img id="zoomImg" src="${window.location.origin}/KBA_NOTES/Images/KLT_BMW.jpg" alt="KBA Image">
        </div>` : ''}
      </div>
    `;

    document.getElementById("backBtn").addEventListener("click", () => {
      document.getElementById('noteView').classList.add('hidden');
      document.getElementById('listView').classList.remove('hidden');
      document.querySelector('.right-pane').classList.remove('hidden');
    });

    if (hasImage) {
      let scale = 1;
      let isDragging = false;
      const zoomImg = document.getElementById("zoomImg");
      const imageContainer = document.getElementById("imageContainer");

      document.getElementById("zoomIn").addEventListener("click", () => {
        scale += 0.2;
        zoomImg.style.transform = `scale(${scale})`;
      });

      document.getElementById("zoomOut").addEventListener("click", () => {
        scale = Math.max(1, scale - 0.2);
        zoomImg.style.transform = `scale(${scale})`;
      });

      document.getElementById("resetZoom").addEventListener("click", () => {
        scale = 1;
        zoomImg.style.transform = `scale(${scale}) translate(0,0)`;
        imageContainer.scrollTop = 0;
        imageContainer.scrollLeft = 0;
      });

      zoomImg.addEventListener("mousedown", () => { isDragging = true; zoomImg.style.cursor = "grabbing"; });
      zoomImg.addEventListener("mouseup", () => { isDragging = false; zoomImg.style.cursor = "grab"; });
      zoomImg.addEventListener("mouseleave", () => { isDragging = false; zoomImg.style.cursor = "grab"; });
      zoomImg.addEventListener("mousemove", e => {
        if (!isDragging) return;
        e.preventDefault();
        imageContainer.scrollLeft -= e.movementX;
        imageContainer.scrollTop -= e.movementY;
      });
    }
  }

  loadIndex();
});
</script>
</body>
</html>
