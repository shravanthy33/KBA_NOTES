<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Danfoss KBA Portal</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; background-color: #f8f9fa; display: flex; flex-direction: column; height: 100vh; }
header { background-color: #002b5c; color: white; padding: 1em; }
main { flex: 1; display: flex; overflow: hidden; }
aside { width: 250px; background: #fff; border-right: 1px solid #ccc; overflow-y: auto; }
aside a { display: block; padding: 10px; border-bottom: 1px solid #eee; text-decoration: none; color: #002b5c; cursor: pointer; }
aside a:hover { background: #f0f0f0; }
.content { flex: 1; display: flex; flex-direction: row; }
.left-pane { flex: 2; padding: 20px; overflow-y: auto; }
.right-pane { flex: 1; padding: 20px; overflow-y: auto; background: #fff; display: flex; justify-content: center; align-items: center; }
.right-pane img { max-width: 100%; max-height: 90%; border: 1px solid #ccc; border-radius: 5px; }
.full-width { flex: 1 !important; }
h1, h2 { color: #002b5c; }
ul { padding-left: 20px; }
</style>
</head>
<body>
<header>
  <h1>Danfoss KBA Portal</h1>
</header>
<main>
  <aside id="kba-list">
    Loading KBAs...
  </aside>
  <div class="content" id="kba-content">
    <div class="left-pane">Select a KBA to view details</div>
    <div class="right-pane"></div>
  </div>
</main>

<script>
const INDEX_URL = `${window.location.origin}/KBA_NOTES/index.json`;

// Global loadKBA so onclick works
window.loadKBA = async function(fileName) {
  console.log("Clicked file:", fileName);
  const fileUrl = `${window.location.origin}/KBA_NOTES/${fileName}`;
  console.log("Fetching:", fileUrl);

  try {
    const res = await fetch(fileUrl);
    console.log("Fetch status:", res.status);
    if (!res.ok) throw new Error("Note not found");
    const note = await res.json();
    console.log("Note loaded:", note);
    renderKBA(note);
  } catch (err) {
    document.getElementById("kba-content").innerHTML = `<div class="left-pane"><p>${err.message}</p></div>`;
  }
};

function renderKBA(note) {
  const leftPane = document.createElement("div");
  leftPane.className = "left-pane";
  leftPane.innerHTML = `
    <h1>${note.KBA || ''}: ${note.Title || ''}</h1>
    <p><strong>Date:</strong> ${note.Date || ''}</p>
    <p><strong>Environment:</strong> ${note.Environment || ''}</p>
    <p><strong>Action Definition:</strong> ${note["Action Definition"] || ''}</p>
    <h2>Description</h2><p>${note.Description || ''}</p>
    <h2>Symptom</h2><p>${note.Symptom || ''}</p>
    <h2>Reproducing the Issue</h2>
    <ul>${(note["Reproducing the Issue"] || []).map(step => `<li>${step}</li>`).join('')}</ul>
    <h2>Cause</h2><p>${note.Cause || ''}</p>
    <h2>Resolution</h2><p>${note.Resolution || ''}</p>
    <h2>Additional Info</h2>
    <ul>
      ${note["Additional Info"] ? Object.entries(note["Additional Info"]).map(([k,v]) => `<li><strong>${k}:</strong> ${v}</li>`).join('') : ''}
    </ul>
  `;

  const rightPane = document.createElement("div");
  rightPane.className = "right-pane";
  if (note.Images && note.Images.length) {
    rightPane.innerHTML = `<img src="${note.Images[0]}" alt="KBA Image">`;
  } else {
    leftPane.classList.add("full-width");
    rightPane.style.display = "none";
  }

  const contentDiv = document.getElementById("kba-content");
  contentDiv.innerHTML = "";
  contentDiv.appendChild(leftPane);
  if (note.Images && note.Images.length) {
    contentDiv.appendChild(rightPane);
  }
}

async function loadIndex() {
  try {
    const res = await fetch(INDEX_URL);
    const kbList = await res.json();
    const aside = document.getElementById("kba-list");
    aside.innerHTML = kbList.map(kba => 
      `<a href="javascript:void(0)" onclick="loadKBA('${kba.file}')">${kba.id}</a>`
    ).join("");
  } catch (err) {
    document.getElementById("kba-list").innerHTML = "<p>Error loading index.json</p>";
  }
}

loadIndex();
</script>
</body>
</html>
